name: Build & Publish Signed APT Repo (amd64)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-deb:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm

    steps:
      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y \
            ca-certificates git \
            build-essential pkg-config \
            dpkg-dev debhelper fakeroot \
            rustc cargo

      - uses: actions/checkout@v4

      - name: Build .deb
        run: |
          dpkg-buildpackage -us -uc
          mkdir -p /tmp/debs
          cp -v ../*.deb /tmp/debs/

      - uses: actions/upload-artifact@v4
        with:
          name: debs
          path: /tmp/debs/*.deb

  publish-pages:
    needs: build-deb
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install repo tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils gnupg

      - uses: actions/download-artifact@v4
        with:
          name: debs
          path: debs

      - name: Assemble repo structure
        run: |
          set -eux

          mkdir -p public/pool/main
          cp -v debs/*.deb public/pool/main/

          mkdir -p public/dists/stable/main/binary-amd64

          # Packages + Packages.gz
          (cd public && \
            dpkg-scanpackages --arch amd64 pool /dev/null > dists/stable/main/binary-amd64/Packages)
          gzip -kf public/dists/stable/main/binary-amd64/Packages

          # Copy public signing key to Pages root (so users can curl it)
          cp -v apt/public.gpg public/public.gpg

      - name: Generate Release + sign (InRelease + Release.gpg)
        env:
          APT_GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
          APT_GPG_PASSPHRASE: ${{ secrets.APT_GPG_PASSPHRASE }}
        run: |
          set -eux

          # Import private key
          echo "$APT_GPG_PRIVATE_KEY" | gpg --batch --import

          # Create Release (apt-ftparchive)
          (cd public && apt-ftparchive release dists/stable > dists/stable/Release)

          # Sign Release -> detached signature
          gpg --batch --yes --pinentry-mode loopback \
            --passphrase "$APT_GPG_PASSPHRASE" \
            -abs -o public/dists/stable/Release.gpg public/dists/stable/Release

          # Sign Release -> inline InRelease
          gpg --batch --yes --pinentry-mode loopback \
            --passphrase "$APT_GPG_PASSPHRASE" \
            --clearsign -o public/dists/stable/InRelease public/dists/stable/Release

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
