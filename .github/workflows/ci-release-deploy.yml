name: Build â€¢ Release â€¢ Deploy APT Repo

on:
  release:
    types:
      - created
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true

permissions:
  contents: write
  pages: write

env:
  GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

jobs:
  build:
    name: Build Debian package
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.setver.outputs.release_tag }}
      deb_path: ${{ steps.package.outputs.deb_path }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clean build artifacts
        run: |
          rm -rf target apt-repo ~/.cargo/registry ~/.cargo/git
        shell: bash

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev gnupg
        shell: bash

      - name: Determine release tag
        id: setver
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "release_tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "release_tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Update Cargo.toml version
        run: |
          TAG="${{ steps.setver.outputs.release_tag }}"
          VERSION="${TAG#v}"
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
        shell: bash

      - name: Build Debian package
        id: package
        run: |
          cargo install cargo-deb --version 2.11.0 --force --locked
          cargo deb
          F=$(find target/debian -name '*.deb' -print -quit)
          if [ -z "$F" ]; then
            echo "No .deb file found!" >&2
            exit 1
          fi
          echo "deb_path=$F" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: ${{ steps.package.outputs.deb_path }}

  release:
    name: Create GitHub release & upload .deb
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download .deb artifact
        uses: actions/download-artifact@v4
        with:
          name: deb-package

      - name: Debug List .deb files
        run: find . -name '*.deb' -ls

      - name: Create release & upload .deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.build.outputs.release_tag }}"
          DEB=$(find . -name '*.deb' -print -quit)
          
          echo "TAG=$TAG"
          echo "DEB=$DEB"
          
          if [ ! -f "$DEB" ]; then
            echo "No .deb file found at $DEB, skipping upload."
            exit 0
          fi
          
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists"
          else
            gh release create "$TAG" \
              --title "Release $TAG" \
              --notes "Automated release for envoyctl $TAG"
          fi
          
          gh release upload "$TAG" "$DEB" --clobber
        shell: bash

  deploy:
    name: Prepare & Deploy APT repo
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download .deb artifact
        uses: actions/download-artifact@v4
        with:
          name: deb-package

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

      - name: Ensure apt-repo directory exists
        run: mkdir -p apt-repo

      - name: Export GPG public key
        run: |
          KEY_ID=$(gpg --list-keys --keyid-format SHORT | grep -E "^pub" | head -1 | awk '{print $2}' | cut -d'/' -f2)
          gpg --armor --export "$KEY_ID" > apt-repo/public.gpg
          if [ ! -s apt-repo/public.gpg ]; then
            echo "ERROR: public.gpg is empty!"
            exit 1
          fi

      - name: Prepare APT repo
        env:
          RELEASE_TAG: ${{ needs.build.outputs.release_tag }}
        run: |
          DEB=$(find . -name '*.deb' -print -quit)
          if [ ! -f "$DEB" ]; then
            echo "No .deb file found, aborting."
            exit 1
          fi
          
          mkdir -p apt-repo/pool/main/e/envoyctl \
                   apt-repo/dists/stable/main/binary-amd64
          
          cp "$DEB" apt-repo/pool/main/e/envoyctl/
          
          cd apt-repo
          dpkg-scanpackages --arch amd64 pool > dists/stable/main/binary-amd64/Packages
          gzip -kf dists/stable/main/binary-amd64/Packages
          
          printf '%s\n' \
            "Origin: envoyctl" \
            "Label: envoyctl" \
            "Suite: stable" \
            "Codename: stable" \
            "Version: ${RELEASE_TAG}" \
            "Architectures: amd64" \
            "Components: main" \
            "Description: Envoy configuration management tool" \
            "Date: $(date -Ru)" \
            > dists/stable/Release
          
          apt-ftparchive release dists/stable >> dists/stable/Release
          
          echo "${GPG_PASSPHRASE}" \
            | gpg --batch --passphrase-fd 0 --pinentry-mode loopback -abs \
            -o dists/stable/Release.gpg \
            dists/stable/Release
          
          echo "${GPG_PASSPHRASE}" \
            | gpg --batch --passphrase-fd 0 --pinentry-mode loopback --clearsign \
            -o dists/stable/InRelease \
            dists/stable/Release
          
          cd ..
        shell: bash

      - name: Create index.html
        run: |
          cat > apt-repo/index.html <<'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>envoyctl APT Repository</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
              h1 { color: #333; }
              pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
              code { background: #e8e8e8; padding: 2px 6px; border-radius: 3px; }
              .step { margin: 20px 0; }
            </style>
          </head>
          <body>
            <h1>ðŸ“¦ envoyctl APT Repository</h1>
            <p>This is the APT repository for <strong>envoyctl</strong> - Envoy configuration management tool.</p>
            
            <h2>Installation</h2>
            
            <div class="step">
              <h3>1. Add the GPG key</h3>
              <pre>sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://boniface.github.io/envoyctl/public.gpg \
            | sudo gpg --dearmor -o /etc/apt/keyrings/envoyctl.gpg</pre>
            </div>
            
            <div class="step">
              <h3>2. Add the repository</h3>
              <pre>echo "deb [signed-by=/etc/apt/keyrings/envoyctl.gpg] https://boniface.github.io/envoyctl stable main" \
            | sudo tee /etc/apt/sources.list.d/envoyctl.list</pre>
            </div>
            
            <div class="step">
              <h3>3. Install</h3>
              <pre>sudo apt update
          sudo apt install envoyctl</pre>
            </div>
            
            <h2>Repository Files</h2>
            <ul>
              <li><a href="public.gpg">public.gpg</a> - GPG public key</li>
              <li><a href="dists/stable/Release">dists/stable/Release</a> - Release file</li>
              <li><a href="dists/stable/main/binary-amd64/Packages">Packages</a> - Package list</li>
            </ul>
            
            <h2>Links</h2>
            <ul>
              <li><a href="https://github.com/boniface/envoyctl">GitHub Repository</a></li>
              <li><a href="https://github.com/boniface/envoyctl/releases">Releases</a></li>
            </ul>
          </body>
          </html>
          HTMLEOF
        shell: bash

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: apt-repo
          target-folder: /
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: gh-pages
          clean: true
          single-commit: true

